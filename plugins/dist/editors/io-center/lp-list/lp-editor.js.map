{"version":3,"file":"lp-editor.js","sourceRoot":"","sources":["../../../../src/editors/io-center/lp-list/lp-editor.ts"],"names":[],"mappings":";AAAA,OAAO,EAAC,GAAG,EAAE,aAAa,EAAE,IAAI,EAAE,UAAU,EAAE,QAAQ,EAAE,KAAK,EAAE,KAAK,EAAC,MAAM,aAAa,CAAC;AACzF,OAAO,oBAAoB,CAAC;AAC5B,OAAO,2BAA2B,CAAC;AACnC,OAAO,gCAAgC,CAAC;AACxC,OAAO,mCAAmC,CAAC;AAC3C,OAAO,6DAA6D,CAAC;AACrE,OAAO,+BAA+B,CAAC;AACvC,OAAO,gCAAgC,CAAC;AACxC,OAAO,oCAAoC,CAAC;AAC5C,OAAO,EAAC,kBAAkB,EAAE,yBAAyB,EAAE,iBAAiB,EAAC,MAAM,0BAA0B,CAAC;AAI1G,OAAO,EAAC,aAAa,EAAC,MAAM,mBAAmB,CAAC;AAIzC,IAAM,QAAQ,GAAd,MAAM,QAAS,SAAQ,UAAU;IAwBtC;QACE,KAAK,EAAE,CAAC;QArByB,cAAS,GAAG,KAAK,CAAC;QACnB,QAAG,GAA4B,SAAS,CAAC;QAE1D,gBAAW,GAAG,KAAK,CAAC;QAC5B,WAAM,GAAW,EAAE,CAAC;QACpB,WAAM,GAAW,EAAE,CAAC;QACpB,WAAM,GAAW,EAAE,CAAC;QACpB,WAAM,GAAW,GAAG,CAAC;QACrB,oBAAe,GAAoD,EAAE,CAAC;QAEvE,YAAO,GAAG;YAChB,MAAM;YACN,MAAM;YACN,MAAM;YACN,MAAM;SACP,CAAC;QAGM,kBAAa,GAAG,aAAa,CAAC,WAAW,EAAE,CAAC;IAIpD,CAAC;IAEO,YAAY;QAClB,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;IACxB,CAAC;IAEO,iBAAiB,CAAC,KAAkB;QAC1C,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;QAEvB,IAAI,KAAK,CAAC,MAAM,EAAE;YAChB,MAAM,IAAI,GAAG,KAAK,CAAC,MAAM,CAAC;YAC1B,IAAI,CAAC,IAAI,EAAE;gBACT,OAAO,CAAC,KAAK,CAAC,6BAA6B,CAAC,CAAC;gBAC7C,OAAO;aACR;YAED,IAAI,CAAC,SAAS,EAAE,CAAC;YACjB,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;YAEvB,MAAM,WAAW,GAAe;gBAC9B,EAAE,EAAE,MAAM,CAAC,UAAU,EAAE;gBACvB,IAAI,EAAE,IAAI,CAAC,MAAM;gBACjB,IAAI,EAAE,IAAI,CAAC,MAAM;gBACjB,IAAI,EAAE,IAAI;gBACV,MAAM,EAAE,IAAI,CAAC,MAAM;gBACnB,OAAO,EAAE,IAAI,CAAC,MAAM;gBACpB,KAAK,EAAE,KAAK;gBACZ,UAAU,EAAE;oBACV,EAAE,EAAE,EAAE,MAAM,CAAC,UAAU,EAAE,EAAE,IAAI,EAAE,KAAK,EAAE,IAAI,EAAE,QAAQ,EAAE;iBACzD;aACF,CAAC;YAEF,IAAI,CAAC,aAAa,CAAC,SAAS,CAAC,WAAW,CAAC,CAAC;YAE1C,IAAI,CAAC,QAAQ,EAAE,CAAC;SACjB;IAEH,CAAC;IAEO,0BAA0B,CAAC,KAAkB;QACnD,IAAI,CAAC,WAAW,GAAG,KAAK,CAAC,MAAM,CAAC,OAAO,CAAC;IAC1C,CAAC;IAEO,eAAe;QACrB,MAAM,YAAY,GAAG,IAAI,CAAC,GAAG,EAAE,gBAAgB,CAAC,WAAW,CAAC,CAAC;QAC7D,IAAI,CAAC,YAAY,EAAE;YACjB,OAAO,EAAE,CAAC;SACX;QAED,MAAM,OAAO,GAAG,KAAK,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC,MAAM,CAAC,CAAC,EAAE,EAAE,EAAE;YACrD,OAAO,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,EAAE,CAAC,YAAY,CAAC,SAAS,CAAC,IAAI,EAAE,CAAC,CAAC;QACjE,CAAC,CAAC,CAAC;QAEH,OAAO,OAAO,CAAC,GAAG,CAAC,CAAC,EAAE,EAAE,EAAE;YACxB,OAAO;gBACL,KAAK,EAAE,EAAE,CAAC,YAAY,CAAC,SAAS,CAAC,IAAI,EAAE;gBACvC,KAAK,EAAE,EAAE,CAAC,YAAY,CAAC,SAAS,CAAC,IAAI,EAAE;aACxC,CAAC;QACJ,CAAC,CAAC,CAAC;IACL,CAAC;IAEO,WAAW,CAAC,KAAkB;QACpC,IAAI,CAAC,eAAe,GAAG,KAAK,CAAC,MAAM,CAAA;IACrC,CAAC;IAEO,QAAQ;QACd,IAAI,CAAC,MAAM,GAAG,EAAE,CAAC;QACjB,IAAI,CAAC,MAAM,GAAG,EAAE,CAAC;QACjB,IAAI,CAAC,MAAM,GAAG,EAAE,CAAC;QACjB,IAAI,CAAC,MAAM,GAAG,GAAG,CAAC;QAClB,IAAI,CAAC,SAAS,CAAC,cAAc,EAAE,CAAC;QAChC,IAAI,CAAC,oBAAoB,CAAC,oBAAoB,EAAE,CAAC;QACjD,IAAI,CAAC,oBAAoB,CAAC,cAAc,EAAE,CAAC;QAC3C,IAAI,CAAC,aAAa,EAAE,CAAC;IACvB,CAAC;IAEO,sBAAsB,CAAC,KAAkB;QAC/C,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC,MAAM,CAAC,aAAa,CAAC,CAAC,CAAC,CAAC;QAE5C,IAAI,IAAI,CAAC,oBAAoB,EAAE;YAC7B,IAAI,CAAC,oBAAoB,CAAC,oBAAoB,EAAE,CAAC;YACjD,IAAI,CAAC,oBAAoB,CAAC,OAAO,GAAG,EAAE,CAAC;YACvC,IAAI,CAAC,aAAa,EAAE,CAAC;YACrB,IAAI,CAAC,oBAAoB,CAAC,OAAO,GAAG,IAAI,CAAC,MAAM,CAAC;SACjD;IACH,CAAC;IAEO,SAAS;QACf,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE;YACb,OAAO,CAAC,KAAK,CAAC,2BAA2B,CAAC,CAAC;YAC3C,OAAO;SACR;QAED,MAAM,OAAO,GAAG,IAAI,CAAC,GAAG,CAAC,aAAa,CAAC,kDAAkD,CAAC,CAAC;QAE3F,IAAI,CAAC,OAAO,EAAE;YACZ,OAAO,CAAC,KAAK,CAAC,mCAAmC,CAAC,CAAC;YACnD,OAAO;SACR;QAED,IAAI,SAAS,GAAG,OAAO,CAAC,aAAa,CAAC,eAAe,IAAI,CAAC,MAAM,YAAY,IAAI,CAAC,MAAM,IAAI,CAAC,CAAC;QAE7F,IAAI,CAAC,SAAS,EAAE;YACd,SAAS,GAAG,IAAI,CAAC,GAAG,CAAC,eAAe,CAAC,kCAAkC,EAAE,IAAI,CAAC,CAAC;YAC/E,SAAS,CAAC,YAAY,CAAC,SAAS,EAAE,IAAI,CAAC,MAAM,CAAC,CAAC;YAC/C,SAAS,CAAC,YAAY,CAAC,MAAM,EAAE,IAAI,CAAC,MAAM,CAAC,CAAC;YAC5C,SAAS,CAAC,YAAY,CAAC,QAAQ,EAAE,IAAI,CAAC,MAAM,CAAC,CAAC;YAC9C,OAAO,CAAC,WAAW,CAAC,SAAS,CAAC,CAAC;SAChC;QAED,KAAK,MAAM,CAAC,MAAM,EAAE,UAAU,CAAC,IAAI,MAAM,CAAC,OAAO,CAAC,IAAI,CAAC,eAAe,CAAC,EAAE;YACvE,IAAI,UAAU,GAAG,SAAS,CAAC,aAAa,CAAC,aAAa,MAAM,IAAI,CAAC,CAAC;YAClE,IAAI,CAAC,UAAU,EAAE;gBACf,UAAU,GAAG,IAAI,CAAC,GAAG,CAAC,eAAe,CAAC,kCAAkC,EAAE,KAAK,CAAC,CAAC;gBACjF,UAAU,CAAC,YAAY,CAAC,MAAM,EAAE,MAAM,CAAC,CAAC;gBACxC,SAAS,CAAC,WAAW,CAAC,UAAU,CAAC,CAAC;aACnC;YAED,IAAI,IAAI,CAAC,MAAM,EAAE;gBACf,UAAU,CAAC,YAAY,CAAC,MAAM,EAAE,IAAI,CAAC,MAAM,CAAC,CAAC;aAC9C;YAED,KAAK,MAAM,CAAC,MAAM,EAAE,KAAK,CAAC,IAAI,MAAM,CAAC,OAAO,CAAC,UAAU,CAAC,EAAE;gBACxD,IAAI,UAAU,GAAG,UAAU,CAAC,aAAa,CAAC,aAAa,MAAM,IAAI,CAAC,CAAC;gBACnE,IAAI,CAAC,UAAU,EAAE;oBACf,UAAU,GAAG,IAAI,CAAC,GAAG,CAAC,eAAe,CAAC,kCAAkC,EAAE,KAAK,CAAC,CAAC;oBACjF,UAAU,CAAC,YAAY,CAAC,MAAM,EAAE,MAAM,CAAC,CAAC;oBACxC,UAAU,CAAC,WAAW,CAAC,UAAU,CAAC,CAAC;iBACpC;gBAED,IAAI,UAAU,GAAG,UAAU,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;gBACjD,IAAI,CAAC,UAAU,EAAE;oBACf,UAAU,GAAG,IAAI,CAAC,GAAG,CAAC,eAAe,CAAC,kCAAkC,EAAE,KAAK,CAAC,CAAC;oBACjF,UAAU,CAAC,WAAW,CAAC,UAAU,CAAC,CAAC;iBACpC;gBAED,UAAU,CAAC,WAAW,GAAG,KAAK,CAAC;aAChC;SACF;QAED,OAAO,SAAS,CAAC;IACnB,CAAC;IAED,MAAM;QACJ,OAAO,IAAI,CAAA;;;;;2BAKY,GAAG,EAAE,CAAC,IAAI,CAAC,YAAY,EAAE;;;;;iBAKnC,IAAI,CAAC,SAAS;kBACb,IAAI,CAAC,iBAAiB;;;;qBAInB,CAAC,IAAI,CAAC,WAAW;;+DAEyB,IAAI,CAAC,0BAA0B;;;;uBAIvE,IAAI,CAAC,MAAM;0BACR,IAAI;4BACF,CAAC,iBAAiB,EAAE,kBAAkB,CAAC,EAAE,CAAC,CAAC;gCACvC,CAAC,CAAc,EAAE,EAAE,CAAC,IAAI,CAAC,MAAM,GAAG,CAAC,CAAC,MAAM;;;;;;uBAMnD,IAAI,CAAC,MAAM;0BACR,IAAI;4BACF,CAAC,iBAAiB,CAAC;gCACf,CAAC,CAAc,EAAE,EAAE,CAAC,IAAI,CAAC,MAAM,GAAG,CAAC,CAAC,MAAM;;;;;;uBAMnD,IAAI,CAAC,MAAM;4BACN,CAAC,kBAAkB,CAAC,GAAG,CAAC,EAAE,yBAAyB,CAAC,EAAE,CAAC,CAAC;gCACpD,CAAC,CAAc,EAAE,EAAE,CAAC,IAAI,CAAC,MAAM,GAAG,CAAC,CAAC,MAAM;;;;;;0BAMhD,IAAI;4BACF,CAAC,iBAAiB,CAAC;uBACxB,IAAI,CAAC,eAAe,EAAE;oCACT,IAAI,CAAC,sBAAsB;;;;qBAI1C,IAAI,CAAC,GAAG;0BACH,IAAI,CAAC,MAAM;2BACV,IAAI,CAAC,SAAS;+BACV,IAAI,CAAC,WAAW;;;;;;KAM1C,CAAC;IACJ,CAAC;;AAEM,eAAM,GAAG,GAAG,CAAA;;;;;;;;;;;;;;;;;GAiBlB,CAAC;AA5PmB;IAApB,KAAK,CAAC,YAAY,CAAC;2CAA+B;AAClB;IAAhC,KAAK,CAAC,wBAAwB,CAAC;sDAAqD;AAE1D;IAA1B,QAAQ,CAAC,EAAC,IAAI,EAAE,OAAO,EAAC,CAAC;2CAA2B;AAC3B;IAAzB,QAAQ,CAAC,EAAC,IAAI,EAAE,MAAM,EAAC,CAAC;qCAAkD;AAElE;IAAR,KAAK,EAAE;6CAA6B;AAC5B;IAAR,KAAK,EAAE;wCAAqB;AACpB;IAAR,KAAK,EAAE;wCAAqB;AACpB;IAAR,KAAK,EAAE;wCAAqB;AACpB;IAAR,KAAK,EAAE;wCAAsB;AACrB;IAAR,KAAK,EAAE;iDAAuE;AAZpE,QAAQ;IADpB,aAAa,CAAC,WAAW,CAAC;GACd,QAAQ,CA+PpB;SA/PY,QAAQ","sourcesContent":["import {css, customElement, html, LitElement, property, query, state} from \"lit-element\";\nimport '@material/mwc-icon';\nimport '../components/icon-button';\nimport '../components/forms/text-input';\nimport '../components/forms/selection-box';\nimport '../components/data-attributes-editor/data-attributes-editor';\nimport '../components/io-center-modal';\nimport '../components/forms/form-group';\nimport '../components/forms/openscd-button';\nimport {maxLengthValidator, minLengthOrEmptyValidator, requiredValidator} from \"../validators/validators\";\nimport {FormGroup} from \"../components/forms/form-group\";\nimport {SelectionItem} from \"../components/forms/selection-box\";\nimport {DataAttributesEditor} from \"../components/data-attributes-editor/data-attributes-editor\";\nimport {LpDataService} from \"./lp-data.service\";\nimport {DataObject} from \"../element-manager/data-object\";\n\n@customElement(\"lp-editor\")\nexport class LpEditor extends LitElement {\n  @query('form-group') private formGroup!: FormGroup;\n  @query('data-attributes-editor') private dataAttributesEditor!: DataAttributesEditor;\n\n  @property({type: Boolean}) private showModal = false;\n  @property({type: Object}) private doc: XMLDocument | undefined = undefined;\n\n  @state() private isFormValid = false;\n  @state() lpName: string = '';\n  @state() lpDesc: string = '';\n  @state() lpType: string = '';\n  @state() lpInst: string = '0';\n  @state() attributeValues: { [doName: string]: { [daName: string]: any } } = {};\n\n  private lpTypes = [\n    \"LPDI\",\n    \"LPDO\",\n    \"LPAI\",\n    \"LPAO\"\n  ];\n\n  \n  private lpDataService = LpDataService.getInstance();\n\n  constructor() {\n    super();\n  }\n\n  private _handleClick() {\n    this.showModal = true;\n  }\n\n  private _handleModalClose(event: CustomEvent) {\n    this.showModal = false;\n\n    if (event.detail) {\n      const data = event.detail;\n      if (!data) {\n        console.error('No data received from modal');\n        return;\n      }\n\n      this.saveToXml();\n      this.showModal = false;\n\n      const logicalNode: DataObject = {\n        id: crypto.randomUUID(),\n        name: this.lpName,\n        desc: this.lpDesc,\n        type: \"LP\",\n        lnInst: this.lpInst,\n        lnClass: this.lpType,\n        ldRef: 'LD0',\n        connectors: [\n          { id: crypto.randomUUID(), name: 'Ind', type: 'output' },\n        ],\n      };\n\n      this.lpDataService.addLpData(logicalNode);\n\n      this.resetAll();\n    }\n\n  }\n\n  private _handleFormValidityChanged(event: CustomEvent) {\n    this.isFormValid = event.detail.isValid;\n  }\n\n  private getLogicalNodes(): SelectionItem[] {\n    const logicalNodes = this.doc?.querySelectorAll('LNodeType');\n    if (!logicalNodes) {\n      return [];\n    }\n\n    const lpTypes = Array.from(logicalNodes).filter((ln) => {\n      return this.lpTypes.includes(ln.getAttribute('lnClass') || '');\n    });\n\n    return lpTypes.map((ln) => {\n      return {\n        label: ln.getAttribute('lnClass') || '',\n        value: ln.getAttribute('lnClass') || ''\n      };\n    });\n  }\n\n  private dataChanged(event: CustomEvent) {\n    this.attributeValues = event.detail\n  }\n\n  private resetAll() {\n    this.lpName = '';\n    this.lpDesc = '';\n    this.lpType = '';\n    this.lpInst = '1';\n    this.formGroup.resetFormGroup();\n    this.dataAttributesEditor.resetAttributeValues();\n    this.dataAttributesEditor.clearComponent();\n    this.requestUpdate();\n  }\n\n  private _handleSelectionChange(event: CustomEvent) {\n    this.lpType = event.detail.selectedItems[0];\n\n    if (this.dataAttributesEditor) {\n      this.dataAttributesEditor.resetAttributeValues();\n      this.dataAttributesEditor.lnClass = '';\n      this.requestUpdate();\n      this.dataAttributesEditor.lnClass = this.lpType;\n    }\n  }\n\n  private saveToXml() {\n    if (!this.doc) {\n      console.error('No XML document available');\n      return;\n    }\n\n    const lDevice = this.doc.querySelector(`IED > AccessPoint > Server > LDevice[inst=\"LD0\"]`);\n\n    if (!lDevice) {\n      console.error('LDevice with inst=\"LD0\" not found');\n      return;\n    }\n\n    let lnElement = lDevice.querySelector(`LN[lnClass=\"${this.lpType}\"][inst=\"${this.lpName}\"]`);\n\n    if (!lnElement) {\n      lnElement = this.doc.createElementNS('http://www.iec.ch/61850/2003/SCL', 'LN');\n      lnElement.setAttribute('lnClass', this.lpType);\n      lnElement.setAttribute('inst', this.lpInst);\n      lnElement.setAttribute('lnType', this.lpName);\n      lDevice.appendChild(lnElement);\n    }\n\n    for (const [doName, attributes] of Object.entries(this.attributeValues)) {\n      let doiElement = lnElement.querySelector(`DOI[name=\"${doName}\"]`);\n      if (!doiElement) {\n        doiElement = this.doc.createElementNS('http://www.iec.ch/61850/2003/SCL', 'DOI');\n        doiElement.setAttribute('name', doName);\n        lnElement.appendChild(doiElement);\n      }\n\n      if (this.lpDesc) {\n        doiElement.setAttribute('desc', this.lpDesc);\n      }\n\n      for (const [daName, value] of Object.entries(attributes)) {\n        let daiElement = doiElement.querySelector(`DAI[name=\"${daName}\"]`);\n        if (!daiElement) {\n          daiElement = this.doc.createElementNS('http://www.iec.ch/61850/2003/SCL', 'DAI');\n          daiElement.setAttribute('name', daName);\n          doiElement.appendChild(daiElement);\n        }\n\n        let valElement = daiElement.querySelector('Val');\n        if (!valElement) {\n          valElement = this.doc.createElementNS('http://www.iec.ch/61850/2003/SCL', 'Val');\n          daiElement.appendChild(valElement);\n        }\n\n        valElement.textContent = value;\n      }\n    }\n\n    return lnElement;\n  }\n\n  render() {\n    return html`\n      <div class=\"lp-editor\">\n        <openscd-button\n          icon=\"add_circle\"\n          label=\"Add LP\"\n          @button-click=\"${() => this._handleClick()}\">\n        </openscd-button>\n      </div>\n\n      <io-center-modal\n        .open=\"${this.showModal}\"\n        @close=\"${this._handleModalClose}\"\n        confirmText=\"Save\"\n        modalHeight=\"80%\"\n        title=\"Edit LP\"\n        .disabled=\"${!this.isFormValid}\">\n        <div class=\"lp-editor-content\">\n          <form-group id=\"formGroup\" @form-validity-changed=\"${this._handleFormValidityChanged}\">\n\n            <text-input\n              name=\"lpName\"\n              .value=${this.lpName}\n              .required=${true}\n              .validators=${[requiredValidator, maxLengthValidator(10)]}\n              @value-changed=\"${(e: CustomEvent) => this.lpName = e.detail}\"\n              label=\"LP Name\">\n            </text-input>\n\n            <text-input\n              name=\"lpInst\"\n              .value=${this.lpInst}\n              .required=${true}\n              .validators=${[requiredValidator]}\n              @value-changed=\"${(e: CustomEvent) => this.lpInst = e.detail}\"\n              label=\"LP Instance\">\n            </text-input>\n\n            <text-input\n              name=\"lpDesc\"\n              .value=${this.lpDesc}\n              .validators=${[maxLengthValidator(100), minLengthOrEmptyValidator(10)]}\n              @value-changed=\"${(e: CustomEvent) => this.lpDesc = e.detail}\"\n              label=\"LP Description\">\n            </text-input>\n\n            <selection-box\n              label=\"LP Type Selection\"\n              .required=${true}\n              .validators=${[requiredValidator]}\n              .items=${this.getLogicalNodes()}\n              @selection-changed=\"${this._handleSelectionChange}\">\n            </selection-box>\n\n            <data-attributes-editor\n              .doc=${this.doc}\n              .lnClass=\"${this.lpType}\"\n              .formGroup=${this.formGroup}\n              @data-changed=\"${this.dataChanged}\">\n            </data-attributes-editor>\n\n          </form-group>\n        </div>\n      </io-center-modal>\n    `;\n  }\n\n  static styles = css`\n    :host {\n      display: block;\n    }\n\n    .lp-editor {\n      height: 100%;\n      display: flex;\n      justify-content: center;\n      align-items: center;\n      padding: 0 0.5rem;\n    }\n\n    .lp-editor-content {\n      width: 100%;\n      height: 100%;\n    }\n  `;\n\n}\n"]}